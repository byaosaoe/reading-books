- 서버를 아무리 많이 설치해도 그 서버에 네트워크가 연결되어 있지 않다면 무용지물이다.

<br/>

# 6.1 Amazon VPC란: AWS에 생성하는 가상 네트워크
- Amazon VPC란 AWS가 제공하는 AWS 계정 전용 가상 네트워크이다.
- 네트워크와 서브넷 범위, 라우팅 테이블, 네트워크 게이트웨이 등 가상 네트워킹 환경을 설정할 수 있다.

<br/>

## 6.1.1 Amazon VPC란
- 웹 서버나 데이터베이스 서버와 같은 **서버들은 네트워크에 연결되어 있어야 한다.**
- 한 장소에 모아서 네트워크를 연결하는 것도 가능하지만 그렇게 되면 서버로서의 의미가 없다.
- 네트워크를 구축하기 위해 사용되는 것이 Amazon Virtual Private Cloud(Amazon VPC)이다
- AWS 계정 전용 가상 네트워크 서비스로, AWS에서 제공하는 리소스만 설치할 수 있다.
- 특히 EC2나 RDS의 경우 VPC를 선택하지 않으면 서버를 생성할 수 없기 때문에 리소스를 사용하기 위해서는 반드시 필요한 서비스이다.

<br/>

## 6.1.2 VPC의 구성
- VPC 내에 서버를 설치하면 해당 네트워크에 소속되지만, 별도로 설정하지 않는다면 VPC 자체는 격리된 네트워크가 된다.
- 외부와 통신하려면 VPC를 인터넷 혹은 회사 내 LAN과 연결해야 한다.
![image](https://github.com/user-attachments/assets/61e6fabf-c22f-477e-86be-13c5de47947e)

<br/>

## 6.1.3 VPC의 기능
- VPC의 주요 기능

|항목|내용|
|:---|:---|
|CIDR 블록|서브넷을 말한다. 네트워크를 나눈 범위이다. VPC를 생성할 때 네트워크 범위를 CIDR로 정하고 이를 더 작은 서브넷으로 나누어 사용한다.|
|서브넷 마스크|네트워크의 크기를 계산하는 값이다. CIDR는 서브넷 마스크의 표기법 중 하나이다.|
|가용 영역|서브넷이 구축된 물리적 장소이다.|
|인터넷 게이트웨이|인터넷에 접속하기 위한 출입구로, VPC를 인터넷에 연결하지 않을 경우에는 불필요하다.|
|라우팅|어떤 데이터를 어디에 보낼지 조정한다. 인터넷 게이트웨이와 라우팅으로 데이터 송수신을 설정하지 않으면 VPC가 인터넷과 접속되지 않는다. 가정이나 기업의 라우터(가정은 공유기) 장비가 이 역할을 수행하는 경우가 많지만, AWS는 소프트웨어가 이 기능을 담당한다.|
|라우팅 테이블|라우팅에 대한 설정이 기록된 테이블이다.|
|보안 그룹|AWS가 제공하는 가상 방화벽이다. 인스턴스 단위로 설정하며 유입되는 데이터는 '거부'는 기본 설정이다.|
|네트워크 ACL|AWS가 제공하는 가상 방화벽이다. 서브넷 단위로 설정된다.|

<br/>

## 6.1.4 VPC 네트워크의 특징과 라우팅 테이블
- VPC는 물리적인 라우터가 아닌 소프트웨어가 라우터 역할을 하며 라우팅을 수행한다.
- 라우팅은 설정된 라우팅 테이블에 따라 동작하는데, 라우팅 테이블 하나에 서브넷 여러 개를 설정할 수 있다.
- 물리적인 서버의 경우 LAN 케이블과 와이파이로 라우터와 연결하겠지만, 클라우드는 라우팅 테이블로 연결한다.
- 일반적인 서브넷 사이의 통신은 라우터로 이루어지지만, VPC의 경우는 라우터없이 직접 통신할 수 있다.
- 또한, VPC 하나에 인터넷 게이트웨이 한 개만 설정할 수 있다.
- 라우터와 인터넷 게이트웨이는 명시적인 IP 주소가 부여되지 않는다. 이는 클라우드의 특징이라고 할 수 있다.
- VPC 네트워크의 특징은 다음과 같다.
1. 소프트웨어가 라우팅한다. 라우터는 IP 주소를 갖지 않는다.
2. 라우팅 테이블 한 개에 서브넷 여러 개를 설정할 수 있다.
3. VPC 한 개에 인터넷 게이트웨이는 한 개만 설정할 수 있고, IP 주소를 갖지 않는다.
4. 서브넷 사이의 통신은 라우터 없이 직접 통신할 수 있다.

<hr/>

# 6.2 VPC의 사용 절차: 가상 네트워크를 사용하자
## 6.2.1 VPC 설정을 위해 꼭 필요한 사항
- VPC는 네트워크이다. 따라서 서버(인스턴스)가 어떤 환경에 설치되어 있는지 그리고인터넷에 연결해야 하는지에 대한 설정이 필요하다.
- 특히 중요한 것은 인터넷 연결 여부와 오토 스케일링이다. 인터넷에 연결해야 한다면 인터넷 게이트웨이를 설정해야 하고, 오토 스케일링을 설정해야 한다면 서버가 자동으로 늘어나기 때문에 IP 주소를 많이 확보해 두어야 한다.
- 보안 그룹과 네트워크 ACL을 설정하려면 인스턴스 용도에 맞는 포트를 설정하는 것도 고려해야 한다. 모든 포트가 닫힌 것이 기본 설정이므로 서버를 사용하려면 기본 설정을 변경해야 한다.
- VPC는 기본 VPC를 비롯해 기본 서브넷과 보안 그룹도 제공한다. 잘 모른다면 기본 VPC를 추천한다.

<br/>

## 6.2.2 VPC 사용 절차
1. AWS에 로그인한다
    - 리전을 선택하고 관리 콘솔에 접속한다
    - VPC 대시보드에 접속한다
2. VPC를 생성한다
    - VPC 이름을 정한다
    - CIDR 블록을 설정한다
    - 테넌시(하드웨어의 점유 여부)를 선택한다
3. 서브넷을 설정한다
    - 서브넷 이름을 정한다
    - 대상 VPC를 선택한다
    - 가용 영역을 선택한다
    - CIDR 블록(서브넷)을 설정한다
4. 인터넷에 연결한다
    - 인터넷 게이트웨이(IGW)를 생성한다
    - IGW를 VPC를 연결한다
    - 라우팅을 설정(라우팅 테이블을 생성하고 설정)한다

<br/>

# 6.3 기본 VPC: AWS가 제공하는 기본 VPC

## 6.3.1 기본 VPC란
- AWS는 네트워크에 대한 지식이 없어도 이용할 수 있도록 리전별로 기본 VPC를 제공한다.
- 기본 VPC는 특별한 설정 없이 바로 사용할 수 있고, 특별한 요건이 없는 이상 기본 VPC를 사용하는 편이 좋다.
- 기본 VPC에서 Elastic Load Balancing(ELB)과 같은 서비스도 사용할 수 있다.

<br/>

## 6.3.2 기본 VPC의 구성
- 기본 VPC는 서브넷과 인터넷 게이트웨이가 기본적으로 구성되어 있다.
- 네트워크의 범위는 사설 IP 주소 172.31.0.0/16이 부여된다.
- 기본 VPC는 기본 서브넷이라는 서브넷이 가용 영역별로 한 개씩 생성되어 있다.
- 각 서브넷은 /20의 주소 범위로 설정되어 있다.
- 인터넷 게이트웨이도 구성되어 있으므로 인터넷에 접속할 수 있다.
- 인터넷에 접속하고 싶지 않다면 별도의 VPC를 생성하거나 VPC 대시보드에 접속하여 기본 VPC를 변경해야 한다.

<hr/>

# 6.4 서브넷과 DHCP: 사용할 범위 선택
## 6.4.1 서브넷이란
- 서브넷이란 커다란 네트워크를 작게 나눈 네트워크를 말한다.
- 네트워크를 분할해 직접 통신할 수 있는 범위를 좁히고, 방화벽을 설정해 보안을 강화하는 것을 목적으로 한다.
- AWS의 경우에는 어떤 가용 영역에 서브넷을 둘지 설정한다. 즉, 서브넷은 물리적인 장소를 특정한다.
- VPC는 사용자가 사용할 수 있는 네트워크 범위를 생성하고 그 아래에 용도에 따라서 서브넷을 생성한다.
- 서브넷을 나누어 서브넷 A는 공개하고, 서브넷 B는 비공개하는 식으로 서브넷별로 역할을 다르게 부여할 수도 있다.
- 일반적인 네트워크의 경우 서브넷끼리 통신하려면 라우팅이 필요하지만, VPC의 경우에는 라우팅 없이도 통신할 수 있다.

<br/>

## 6.4.2 네트워크의 범위와 CIDR 표기
- 네트워크와 서브넷의 범위를 나누는 데 사용되는 표기법을 CIDR(Classless Inter-Domain Routing)라고 한다.
- 프리픽스 표기라고도 하는데 /24, /20처럼 슬래시 뒤에 네트워크 길이를 숫자로 적어서 표기한다.
- CIDR는 IP 주소의 수를 나타낸다. /24면 256개, /20이면 4,096개를 의미한다.
- 2의 '32 - 네트워크 길이' 제곱을 기억하면 쉽게 계산할 수 있다.

<br/>

## 6.4.3 네트워크 클래스

|클래스|CIDR|IP 주소 수|사설 IP 범위|
|:---|:---|:---|:---|
|A클래스|/8 ~ /15|131,072 ~ 16,777,216|10.0.0.0 ~ 10.255.255.255|
|B클래스|/16 ~ /23|512 ~ 65,536|172.16.0.0 ~ 172.31.255.255|
|C클래스|/24 ~ /32|1 ~ 256|192.168.0.0 ~ 192.168.255.255|

- 기본 VPC는 /16(B 클래스)으로 설정되어 있으며 이를 /20으로 분할한 서브넷이 각 가용 영역에 구성되어 있다.
- /20 서브넷은 IP 주소 4,096개를 가지며 오토 스케일링을 설정해도 될 만큼 IP 주소를 충분히 많이 가지고 있다.
- 스스로 CIDR를 설정할 때 /16이나 /20 크기를 기준으로 하면 설정하기 쉽다.
- AWS의 경우 부모가 되는 네트워크를 A 클래스로 설정할 수 있지만, 서브넷으로 사용할 수 있는 범위는 /16(B 클래스 최대치) 이하이다. 따라서 A 클래스를 서브넷으로 설정할 수 없다.

<br/>

## 6.4.4 IP 주소 할당과 DHCP
- 일반적인 네트워크의 경우 IP 주소를 할당할 수 있는 것은 EC2 인스턴스와 RDS 인스턴스 등이다.
- 하지만 AWS의 VPC는 EC2 인스턴스나 RDS 인스턴스 외에도 라우터나 인터넷 게이트웨이의 IP 주소로도 앞서 설명한 예약 주소를 사용할 수 있다.
- 네트워크 및 서브넷에 사용되는 IP 주소의 범위는 관리자가 설정할 수 있고, DHCP(Dynamic Host Configuration Protocol)에서 각 호스트에 IP 주소를 자동으로 할당한다.
- VPC에는 DHCP 서버가 동작하고 있어 인스턴스가 추가되면 해당 서브넷 범위의 IP 주소 중에 하나가 할당된다.
- VPC가 일반적으로 사용하는 IP 주소는 사설 IP 주소이다.

<hr/>

# 6.5 라우팅과 NAT: 공인 IP 주소와 사설 IP 주소 변환

## 6.5.1 네트워크와 라우팅
- 네트워크란 PC 여러 대가 서로 통신할 수 있도록 연결되어 있는 상태를 말한다.
- 라우팅은 여러 물동이를 거쳐 물을 전달하는 것처럼 호스트에서 호스트로 데이터를 전달하는 형태로 데이터를 송신한다.

<br/>

## 6.5.2 IP 주소와 게이트웨이
- 라우터가 각 PC에 데이터를 전달하려면 대상을 식별할 수 있는 주소가 필요하다.
- 이 주소 역할을 하는 것이 IP 주소이다.
- IP 주소는 클라이언트나 PC나 서버뿐만 아니라 라우터 등 네트워크 안의 모든 호스트에 설정되어 있다.
1. 목적지에 데이터를 보낼 때 목적지의 IP 주소를 지정한다.
2. 그러고 나서 데이터를 우선 네트워크 사이를 연결하는 라우터로 보낸다.
3. 데이터를 받은 라우터는 자신의 네트워크 내에 목적지아 있는지 확인하고, 목적지가 있다면 데이터를 그 목적지(호스트)로 전달한다. 목적지가 없다면 다른 라우터로 전송한다.
4. 라우터에는 목적지로 가장 빠르게 전송할 수 있는 경로 정보가 설정되어 있어서 빠르게 데이터를 전송한다.
- 라우터는 네트워크의 관문에 위치해 있기 때문에 관문이라는 의미로 게이트웨이라고도 한다.
- 게이트웨이 중에 '자신 이외의 접속되어 있는 모든 것(대부분의 경우 인터넷과의 연결점)'을 기본 게이트웨이라고 한다.

<br/>

## 6.5.3 IP 마스커레이드
- LAN 이외에는 기본적으로 인터넷을 거쳐야 한다.
- LAN에서 인터넷으로 데이터를 전송할 때 LAN 내부의 출입구가 되는 것이 게이트웨이이다.
- 게이트웨이는 기기의 역할을 말하며 실제 기기는 라우터이다.
- ALN에서 전송되는 데이터를 인터넷으로 보내고, 인터넷에서 들어오는 데이터를 목적지 PC로 전송한다.
- 요즘 LAN 내부의 PC에는 전부 사설 IP 주소를 할당하는 게 일반적이다. 하지만 인터넷상에서 공인 IP 주소가 없다면 식별할 수 없기 때문에 게이트웨이가 사설 IP 주소를 공인 IP 주소로 변환하고 가정 내에서 혹은 회사 내에서는 공인 IP 주소 하나를 공동으로 사용한다.
- 주소 변환을 담당하는 것이 IP 마스커레이드(NAPT, Network Address Port Translation)이다.

<br/>

## 6.5.4 NAT
- IP 마스커레이드를 사용하면 내부에서 외부로 나가는 것은 가능하지만, 외부에서 내부로 들어오는 것은 불가능하다.
- IP 마스커레이드는 내부에서 외부로 요청하는 것에 응답하지만, 외부에서 내부로 요청하는 것에는 응답하지 않기 때문이다.
- PC(클라이언트)의 경우는 문제가 없지만, LAN 환경에 서버를 설치한 경우에는 당연히 외부 요청에 대해 응답해야 한다. 이럴 경우 서버만 양방향으로 통신할 수 있도록 IP 마스커레이드를 설정할 수 있다.
- 하지만 IP 마스커레이드는 공인 IP 하나만 설정할 수 있기 때문에 서버가 여러 대라면 공인 IP 주소를 여러 개 설정할 수 있는 NAT를 사용해야 한다.
- IP 마스커레이드와 NAT는 비슷하지만, IP 마스커레이드는 일대다인 것에 비해 NAT는 다대다라는 점이 다르다.
- IP 마스커레이드는 포트를 변환할 수 있지만 NAT는 포트를 변환할 수 없다는 점도 다르다.
    - 포트: 호스트상에 어떤 소프트웨어와 통신할 것인지 식별하는 번호
