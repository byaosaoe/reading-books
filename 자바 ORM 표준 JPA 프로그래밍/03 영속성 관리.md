- JPA가 제공하는 기능
  1. 엔티티와 테이블을 매핑하는 설계 부분
  2. 매핑한 엔티티를 실제 사용하는 부분
- 엔티티 매니저: 엔티티 저장, 수정, 삭제, 조회 등 엔티티와 관련된 모든 일을 처리한다.

<hr/>

# 3.1 엔티티 매니저 팩토리와 엔티티 매니저
- 데이터베이스를 하나만 사용하는 애플리케이션은 하나의 EntityManagerFactory만 생성하는게 일반적이다.
- 엔티티 매니저 팩토리를 만드는 비용은 상당히 크기 때문에 한 개만 만들어서 애플리케이션 전체에서 공유하게 설계되었다.
- 반면 엔티티 매니저를 생성하는 비용은 거의 들지 않는다.
- 엔티티 매니저 팩토리는 여러 스레드가 동시에 접근해도 안전하므로 서로 다른 스레드 간에 공유해도 된다.
- 엔티티 매니저는 여러 스레드가 동시에 접근하면 **동시성 문제**가 발생하므로 스레드 간에 절대 공유하면 안 된다.
- 엔티티 매니저는 데이터베이스 연결이 꼭 필요한 시점까지 커넥션을 얻지 않는다.

<hr/>

# 3.2 영속성 컨텍스트란?
- 영속성 컨텍스트(persistence context): 엔티티를 영구 저장하는 환경
- 엔티티 매니저로 엔티티를 저장하거나 조회하면 엔티티 매니저는 영속성 컨텍스트에 엔티티를 보관하고 관리한다.
- `persist()` 메서드는 엔티티 매니저를 사용해서 회원 엔티티를 영속성 컨텍스트에 저장한다.
- 영속성 컨텍스트는 엔티티 매니저를 생성할 때 하나 만들어진다.
- 여러 엔티티 매니저가 같은 영속성 컨텍스트에 접근할 수도 있다.

<hr/>

# 3.3 엔티티의 생명주기
- 엔티티의 4가지 상태
  - 비영속(new/transient): 영속성 컨텍스트와 전혀 관계가 없는 상태
  - 영속(managed): 영속성 컨텍스트에 저장된 상태
  - 준영속(detached): 영속성 컨텍스트에 저장되었다가 분리된 상태
  - 삭제(removed): 삭제된 상태

![image](https://github.com/user-attachments/assets/6a3bd31c-e6aa-4c48-aca9-8d8331dbeed1)

출처: https://djcho.github.io/jpa/jpa-chapter3-3/

- 비영속
  - 객체를 생성만 한 상태. 순수한 객체 상태이며 아직 저장하지 않았다.
- 영속
  - 엔티티 매니저를 통해서 엔티티를 영속성 컨텍스트에 저장한 상태
  - 영속성 컨텍스트에 의해 관리되는 엔티티의 상태
  - > em.persist(member);
- 준영속
  - 영속성 컨텍스트가 관리하던 영속 상태의 엔티티를 영속성 컨텍스트가 관리하지 않으면 준영속 상태가 된다.
  - `em.detach()`, `em.close() - 닫음`, `em.clear() - 초기화`를 호출하여 엔티티를 준영속 상태로 만들 수 있다.
  - > em.detach(member);
- 삭제
  - 엔티티를 영속성 컨텍스트와 데이터베이스에서 삭제
  - > em.remove(member);

<hr/>

# 3.4 영속성 컨텍스트의 특징
- 영속성 컨텍스트와 식별자 값
  - 영속성 컨텍스트는 엔티티를 식별자 값으로 구분한다.
  - 따라서 영속 상태는 **식별자 값**이 반드시 있어야 한다.
- 영속성 컨텍스트와 데이터베이스 저장
  - JPA는 트랙잭션을 커밋하는 순간 영속성 컨텍스트에 새로 저장된 엔티티를 데이터베이스에 반영한다.
  - 이것을 플러시(flush)라고 한다.
- 영속성 컨텍스트가 엔티티를 관리하는 것의 장점
  1. 1차 캐시
  2. 동일성 보장
  3. 트랙잭션을 지원하는 쓰기 지연
  4. 변경 감지
  5. 지연 로딩

<hr/>

## 3.4.1 엔티티 조회
- 영속성 컨텍스트는 내부에 캐시를 가지고 있고 이것을 1차 캐시라고 한다.
- 영속성 상태의 엔티티는 모두 이 1차 캐시에 저장된다.
- 키가 `@Id`로 매핑한 식별자 값이고, 값이 엔티티 인스턴스인 Map
- 영속성 컨텍스트에 데이터를 저장하고 조회하는 모든 기준은 데이터베이스 기본 키 값이다.
- `em.find()`를 호출하면
  - 먼저 1차 캐시에서 엔티티를 찾고,
  - 만약 찾는 엔티티가 1차 캐시에 없으면 데이터베이스에서 조회하여 엔티티를 생성한다.
    - 생성한 엔티티를 1차 캐시에 저장하고 영속 상태의 엔티티를 반환한다.
